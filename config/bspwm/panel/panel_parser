#! /bin/sh

source ./config

# Colors in lemonbar format
CF="%{F$COLOR_FOREGROUND}"
CB="%{B$COLOR_BACKGROUND}"
CA="%{F$COLOR_ACTIVE}"
CO="%{F$COLOR_OCCUPIED}"
CU="%{F$COLOR_URGENT}"

# Color resets
CFR="%{F-}"
CBR="%{B-}"

# Alignment (left, center, right)
LA="%{l}"
RA="%{r}"

while read -r line ; do
    case $line in
        WM*) # Window manager
            wm_info="${LA}"
            # The fields generated by `bspc` are colon-separated, so we set the
            # "internal field separator" (IFS) variable accordingly
            IFS=":"

            # Make the contents of the line behave like arguments (???)
            set -- ${line#WM}
            while [ $# -gt 0 ]; do
                token=$1
                # Strip off token identifier
                name=${token:1}

                case $token in
                    [OFU]*)
                        # Current workspace
                        wm_info="${wm_info}${CA}%{A:bspc desktop -f ${name}:} ● %{A}${CFR}"
                        ;;
                    o*)
                        # Occupied workspace (not current though)
                        wm_info="${wm_info}${CO}%{A:bspc desktop -f ${name}:} ● %{A}${CFR}"
                        ;;
                    f*)
                        # Free workspace
                        wm_info="${wm_info}${CF}%{A:bspc desktop -f ${name}:} ○ %{A}${CFR}"
                        ;;
                    u*)
                        # Urgent workspace
                        wm_info="${wm_info}${CU}%{A:bspc desktop -f ${name}:} ● %{A}${CFR}"
                        ;;
                    T*)
                        # Layout
                        case $name in
                            =*)
                                layout="Fullscreen"
                                ;;
                            F*)
                                layout="Floating"
                                ;;
                            T*)
                                layout="Tiling"
                                ;;
                        esac
                        wm_info="${wm_info}%{A:bspc desktop -l next:}%{B#1C3C66}[${layout}]%{B-}%{A}"
                esac

                # Move to the next argument
                shift
            done
            ;;
        TITLE*) # Current window title
            title="${line#TITLE}"
            ;;
        SYS*) # Conky system info
            sys_info="${RA}${line#SYS}"
            ;;
    esac
    
    # Need to fill the empty space between the window title and the Conky info,
    # so the overline/underline is applied to the entire bar
    spaces="                                                                           "

    printf "%s\n" "${wm_info} ${title}${spaces}${sys_info}"
done
