#!/usr/bin/env bash

source ./config

# Default FG/BG colors
C_F="%{F$COLOR_FOREGROUND}"
C_B="%{B$COLOR_BACKGROUND}"

# Workspace foreground colors
C_A="%{F$COLOR_ACTIVE}"
C_O="%{F$COLOR_OCCUPIED}"
C_U="%{F$COLOR_URGENT}"
C_FREE="%{F$COLOR_FREE}"

# Layout info background
C_LI="%{B$COLOR_LAYOUT_INFO}"

# Color resets
C_FR="%{F-}"
C_BR="%{B-}"

# Alignment (left, center, right)
LA="%{l}"
RA="%{r}"

while read -r line ; do
    case $line in
        WM*) # Window manager
            wm_info="${LA}%{U${COLOR_FOREGROUND}}"
            # The fields generated by `bspc` are colon-separated, so we set the
            # "internal field separator" (IFS) variable accordingly
            IFS=":"

            # Make the contents of the line behave like arguments (???)
            set -- ${line#WM}
            while [ $# -gt 0 ]; do
                token=$1
                # Strip off token identifier
                name=${token:1}

                case $token in
                    [OFU]*)
                        # Current workspace
                        wm_info="${wm_info}${C_A}%{A:bspc desktop -f ${name}:}%{+u} ${name} %{-u}%{A}${C_FR}"
                        ;;
                    o*)
                        # Occupied workspace (not current though)
                        wm_info="${wm_info}${C_O}%{A:bspc desktop -f ${name}:} ${name} %{A}${C_FR}"
                        ;;
                    f*)
                        # Free workspace
                        wm_info="${wm_info}${C_FREE}%{A:bspc desktop -f ${name}:} ${name} %{A}${C_FR}"
                        ;;
                    u*)
                        # Urgent workspace
                        wm_info="${wm_info}${C_U}%{A:bspc desktop -f ${name}:} ${name} %{A}${C_FR}"
                        ;;
                    T*)
                        # Layout
                        case $name in
                            =*)
                                layout="Fullscreen"
                                ;;
                            F*)
                                layout="Floating"
                                ;;
                            T*)
                                layout="Tiling"
                                ;;
                        esac
                        wm_info="${wm_info}%{A:bspc desktop -l next:}${C_LI} ${layout} %{B-}%{A}"
                esac

                # Move to the next argument
                shift
            done
            ;;
        TITLE*) # Current window title
            title="${line#TITLE}"
            ;;
        SYS*) # Conky system info
            sys_info="${RA}${line#SYS}"
            ;;
    esac

    printf "%s\n" "${wm_info} ${title}${sys_info}"
done
